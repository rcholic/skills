const http = require("http");
const { URL } = require("url");
function readStdin(){return new Promise((res,rej)=>{let d="";process.stdin.setEncoding("utf8");process.stdin.on("data",c=>d+=c);process.stdin.on("end",()=>res(d));process.stdin.on("error",rej);});}
function getJson(url){return new Promise((res,rej)=>{http.get(url, r=>{let d="";r.setEncoding("utf8");r.on("data",c=>d+=c);r.on("end",()=>{if(r.statusCode&&r.statusCode>=400)return rej(new Error(`http ${r.statusCode}: ${d.slice(0,300)}`));try{res(JSON.parse(d));}catch(e){rej(new Error(`invalid json: ${e.message}. body=${d.slice(0,300)}`));}});}).on("error",rej);});}
(async()=>{try{const raw=await readStdin();const args=raw?JSON.parse(raw):{};const query=String(args.query||"").trim();const count=Math.max(1,Math.min(10,Number(args.count||5)));if(!query){console.log(JSON.stringify({error:"missing_query"}));process.exit(0);}const u=new URL("http://host.docker.internal:8081/search");u.searchParams.set("q",query);u.searchParams.set("format","json");const j=await getJson(u.toString());const results=Array.isArray(j.results)?j.results.slice(0,count).map(r=>({title:r.title||"",url:r.url||"",snippet:r.content||r.snippet||"",source:"searxng"})):[];process.stdout.write(JSON.stringify({query,count,results},null,2));}catch(e){process.stdout.write(JSON.stringify({error:"searxng_search_failed",message:e.message}));process.exit(0);}})();
