#!/bin/bash
# Sales Rhythm Tracker â€” Pipeline Health Check
# Reads pipeline and outputs health analysis with recommendations
# Best used on Fridays or when user asks "pipeline review"

SALES_DIR="${HOME}/.openclaw/workspace/sales"
PIPELINE="$SALES_DIR/pipeline.md"
ACTIVITY_LOG="$SALES_DIR/activity-log.md"
TODAY=$(date +"%Y-%m-%d")

if [ ! -f "$PIPELINE" ]; then
  echo "âŒ Pipeline not initialized. Run: init-pipeline.sh first"
  exit 1
fi

echo "============================================"
echo "ðŸ¥ PIPELINE HEALTH REVIEW â€” ${TODAY}"
echo "============================================"
echo ""
echo "ðŸ“‹ FULL PIPELINE:"
cat "$PIPELINE"
echo ""
echo "---"
echo ""
echo "ðŸ“‹ RECENT ACTIVITY (last 14 days):"
cat "$ACTIVITY_LOG" | tail -100
echo ""
echo "---"
echo ""
echo "ðŸ’¡ AGENT INSTRUCTIONS â€” Perform full health analysis:"
echo ""
echo "STEP 1 â€” TEMPERATURE CHECK"
echo "For each active lead, calculate days since Last Contact."
echo "  â€¢ >14 days no contact = ðŸ”´ Red (cooling fast)"
echo "  â€¢ 8-14 days = ðŸŸ¡ Yellow (needs attention)"
echo "  â€¢ <7 days = ðŸŸ¢ Green (healthy rhythm)"
echo ""
echo "STEP 2 â€” STAGE VELOCITY ANALYSIS"
echo "Flag any lead stuck in the same stage past healthy duration:"
echo "  â€¢ connected > 3 days without moving = flag"
echo "  â€¢ qualified > 7 days = flag"
echo "  â€¢ proposal > 10 days = flag"
echo "  â€¢ negotiation > 14 days = flag"
echo "  â€¢ closing > 5 days = URGENT flag"
echo ""
echo "STEP 3 â€” BOILING WATER RISK ASSESSMENT"
echo "Identify leads where momentum is at risk of cooling completely."
echo "These need intervention THIS WEEK or should be classified as lost."
echo ""
echo "STEP 4 â€” FLIP DECISIONS (ç¿»ç‰Œ)"
echo "Identify leads that should be cut from active pipeline:"
echo "  â€¢ No response after 3+ contacts"
echo "  â€¢ Confirmed no budget"
echo "  â€¢ Stuck >21 days with no movement"
echo "Moving these to 'inactive' clears mental bandwidth for live opportunities."
echo ""
echo "STEP 5 â€” PIPELINE METRICS SUMMARY"
echo "Calculate and report:"
echo "  â€¢ Total active leads"
echo "  â€¢ Leads per stage (show as mini funnel)"
echo "  â€¢ Overall pipeline conversion rate estimate"
echo "  â€¢ Expected closes in next 2 weeks"
echo "  â€¢ Red flags count"
echo ""
echo "STEP 6 â€” NEXT WEEK RECOMMENDATIONS"
echo "Based on the analysis:"
echo "  â€¢ What's the sprint phase next week? (Seed/Flip/Harvest/Reset)"
echo "  â€¢ Which 3 leads are the top priorities?"
echo "  â€¢ Which leads should be cut?"
echo "  â€¢ How many new leads need to be added to maintain healthy pipeline?"
echo ""
echo "Format as the Pipeline Health Report structure."
echo "End with one clear directive: the single most important action for Monday morning."
